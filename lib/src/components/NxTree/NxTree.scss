/*
 * Copyright (c) 2019-present Sonatype, Inc.
 * This program and the accompanying materials are made available under
 * the terms of the Eclipse Public License 2.0 which accompanies this
 * distribution and is available at https://www.eclipse.org/legal/epl-2.0/.
 */
@use '../../scss-shared/nx-container-helpers';
@use '../../scss-shared/nx-text-helpers';

.nx-tree {
  $normal-item-label-row-height: 32px;
  $first-item-label-row-height: calc(var(--nx-line-height) * 1em);
  --nx-item-label-row-height: #{$normal-item-label-row-height};

  padding: 0;
  margin: var(--nx-spacing-6x) 0;

  // note that this block must be before the .nx-tree__item block
  &__item--collapsible {
    > .nx-tree, > .nx-tree__line-drop {
      display: none;
    }

    &.open {
      > .nx-tree, > .nx-tree__line-drop {
        display: block;
      }
    }
  }

  &__item {
    align-items: end;
    display: grid;
    grid-template:
      "line-intersection label" var(--nx-item-label-row-height)
      "line-drop      children" auto /
       36px               auto;

    position: relative;

    &:first-child {
      &, > .nx-tree__collapse-label {
        > .nx-tree__line-intersection > .nx-tree__top-line {
          display: none;

          // only display this line for subtrees, not the top-level tree
          .nx-tree__item > .nx-tree > & {
            display: block;
          }
        }
      }

      &:last-child {
        > .nx-tree__line-intersection > .nx-tree__right-line {
          display: none;

          // do not display this line for top level items in non-collapsible trees when they have no siblings
          .nx-tree__item > .nx-tree > & {
            display: block;
          }
        }
      }
    }

    &:last-child {
      &, > .nx-tree__collapse-label {
        > .nx-tree__line-intersection > .nx-tree__bottom-line {
          display: none;
        }

        > .nx-tree__line-drop {
          display: none;
        }
      }
    }

    > .nx-tree {
      grid-area: children;

      // This has as much to do with the width of fixed-width FA icons as anything, so don't expect it to fit our
      // spacing variables cleanly
      margin: 0 0 0 1px;
    }
  }

  > .nx-tree__item:first-child {
    // shorten the item label row only on the first item in the top-level tree
    --nx-item-label-row-height: #{$first-item-label-row-height};

    .nx-tree & {
      --nx-item-label-row-height: #{$normal-item-label-row-height};
    }
  }

  &__line-intersection {
    grid-area: line-intersection;
  }

  &__line-drop {
    grid-area: line-drop;
    height: 100%;

    // this element by itself should not contribute to the grid size. Rather this element derives its size from the grid
    position: absolute;
  }

  &__line-intersection, &__line-drop {
    width: 100%;
    stroke: var(--nx-swatch-grey-50);
    stroke-width: 1px;
  }

  &__collapse-focus {
    display: none;

    fill: none;
    stroke: var(--nx-color-interactive-border-focus);
  }

  &__item-label {
    @include nx-container-helpers.container-horizontal;
    @include nx-text-helpers.truncate-ellipsis;

    grid-area: label;
    margin-left: var(--nx-spacing-base);
  }

  &__collapse-input {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    margin: 0;
    outline: none;
  }

  &__collapse-label {
    cursor: pointer;
    grid-area: line-intersection;
    height: $normal-item-label-row-height;

    &:focus-within {
      .nx-tree__collapse-focus {
        display: inline;
      }
    }
  }

  &--no-gutter > .nx-tree__item {
    grid-template:
      "label"    var(--nx-item-label-row-height)
      "children" auto /
       auto;

    > .nx-tree__collapse-label, > .nx-tree__line-intersection, > .nx-tree__line-drop {
      display: none;
    }
  }
}
